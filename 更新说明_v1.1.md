# 抽样计算工具 - 更新说明 v1.1

## 🎉 新增功能

### 1. ✅ 适配表格下移
- **原来**：数据行在第6-20行
- **现在**：数据行在第8-22行（下移2个单元格）
- 所有查找逻辑已自动适配新的行号范围

### 2. ✅ 自动输出AC/RE值
- **B5单元格**：自动显示AC值（接收数）
- **B6单元格**：自动显示RE值（拒收数）
- 每次计算后自动更新

### 3. ✅ 高亮显示选中单元格
计算完成后，会自动高亮显示：
- **样本量单元格**（L列）：黄色 🟨
- **AC单元格**：浅绿色 🟩
- **RE单元格**：浅绿色 🟩

**特点：**
- 每次计算前会自动清除上一次的高亮
- 如果遇到"上"或"下"，会高亮最终找到数值的单元格
- 直观显示实际使用的数据来源

---

## 📝 使用示例

### 输入：
- **B1** = 15（批量）
- **B2** = II（检验水平）
- **B3** = 1.5（AQL）
- **B4** = `=获取样本量(B1, B2, B3)`

### 自动输出：
- **B4** = 8（样本量）
- **B5** = 0（AC值）✨ **新增**
- **B6** = 1（RE值）✨ **新增**

### 高亮效果：
在主表中会看到：
- 第X行L列（样本量=8）→ 黄色背景
- 第X行对应的AC列（值=0）→ 浅绿色背景
- 第X行对应的RE列（值=1）→ 浅绿色背景

---

## 🎨 高亮颜色说明

| 颜色 | RGB值 | 含义 |
|------|-------|------|
| 🟨 黄色 | (255, 255, 0) | 样本量单元格 |
| 🟩 浅绿色 | (146, 208, 80) | AC/RE单元格 |

### 如何自定义颜色？

在VBA代码中找到以下部分（约第107-112行）：

```vba
' 高亮样本量单元格
ws.Cells(实际行号, 12).Interior.Color = RGB(255, 255, 0) ' 黄色
' 高亮AC单元格
ws.Cells(实际行号, AQL列AC).Interior.Color = RGB(146, 208, 80) ' 浅绿色
' 高亮RE单元格
ws.Cells(实际行号, AQL列RE).Interior.Color = RGB(146, 208, 80) ' 浅绿色
```

**修改RGB值即可：**
- 红色：`RGB(255, 0, 0)`
- 蓝色：`RGB(0, 112, 192)`
- 橙色：`RGB(255, 192, 0)`
- 粉色：`RGB(255, 192, 203)`

---

## 🔄 版本兼容性

### v1.0 → v1.1 迁移
如果您之前使用的是v1.0版本：

1. **备份数据**：保存一份原Excel文件
2. **替换代码**：用新的VBA代码替换旧代码
3. **调整表格**：将标准数据表下移2行
4. **测试功能**：运行几个测试案例，确认正常

### 不兼容说明
- ⚠️ 表格结构已改变（下移2行）
- ⚠️ 如果您的数据仍在第6-20行，需要改回代码中的行号
- ✅ 所有函数名称保持不变，调用方式完全兼容

---

## 🐛 问题修复

### v1.1 修复的问题：
1. ✅ **关键修复**：当遇到"上"或"下"时，现在会正确使用找到数值的行对应的样本量
   - **之前**：样本量=3（错误）
   - **现在**：样本量=8（正确）

2. ✅ 所有行号范围已更新为8-22（适配下移2行）

---

## 📊 完整功能列表

### 核心函数（4个）
| 函数 | 功能 | 示例 |
|------|------|------|
| `获取样本量()` | 返回样本量 | `=获取样本量(15,"II",1.5)` → 8 |
| `获取Ac值()` | 返回AC值 | `=获取Ac值(15,"II",1.5)` → 0 |
| `获取Re值()` | 返回RE值 | `=获取Re值(15,"II",1.5)` → 1 |
| `获取检验类型()` | 返回类型 | `=获取检验类型(15,"II",1.5)` → 抽检 |

### 主函数
```vba
=计算抽样(批量, "检验水平", AQL)
```
返回数组：`{样本量, Ac值, Re值, 检验类型}`

### 新增功能
- ✨ 自动输出AC到B5
- ✨ 自动输出RE到B6
- ✨ 高亮显示选中的单元格
- ✨ 正确处理"上"/"下"时的样本量更新

---

## 💡 使用技巧

### 技巧1：批量计算
创建表格，多行数据一次性计算：

| 批量 | 水平 | AQL | 样本量公式 | AC | RE |
|------|------|-----|-----------|----|----|
| 15 | II | 1.5 | `=获取样本量(A2,B2,C2)` | `=获取Ac值(A2,B2,C2)` | `=获取Re值(A2,B2,C2)` |
| 500 | III | 2.5 | `=获取样本量(A3,B3,C3)` | `=获取Ac值(A3,B3,C3)` | `=获取Re值(A3,B3,C3)` |

向下拖动填充即可。

### 技巧2：监视高亮单元格
每次计算后，可以：
1. 查看高亮的黄色单元格，确认使用的样本量
2. 查看高亮的绿色单元格，确认AC/RE来源
3. 追踪"上"或"下"的查找路径

### 技巧3：使用条件格式
可以对B5、B6设置条件格式：
- 当AC=0时，显示红色（非常严格）
- 当RE>10时，显示绿色（相对宽松）

---

## 🆘 常见问题

### Q：高亮颜色太亮，怎么调淡？
A：修改RGB值，降低饱和度。例如：
```vba
RGB(255, 255, 200)  ' 淡黄色
RGB(200, 255, 200)  ' 淡绿色
```

### Q：不想要高亮功能，怎么关闭？
A：注释掉代码中的这几行（在行首添加单引号）：
```vba
' Call 清除高亮(ws)
' ws.Cells(实际行号, 12).Interior.Color = RGB(255, 255, 0)
' ws.Cells(实际行号, AQL列AC).Interior.Color = RGB(146, 208, 80)
' ws.Cells(实际行号, AQL列RE).Interior.Color = RGB(146, 208, 80)
```

### Q：B5、B6不想显示AC/RE，怎么关闭？
A：注释掉这两行：
```vba
' ws.Range("B5").Value = Ac值
' ws.Range("B6").Value = Re值
```

### Q：想把AC/RE输出到其他单元格？
A：修改"B5"、"B6"为您想要的单元格，如：
```vba
ws.Range("D10").Value = Ac值
ws.Range("D11").Value = Re值
```

---

## 📅 版本历史

### v1.1 (2025-11-22)
- ✅ 适配表格下移2行（第8-22行）
- ✅ 新增：自动输出AC到B5，RE到B6
- ✅ 新增：高亮显示选中的单元格
- ✅ 修复：正确处理"上"/"下"时的样本量更新

### v1.0 (2025-11-21)
- ✅ 实现核心计算功能
- ✅ 支持4个自定义函数
- ✅ 处理"上"、"下"箭头逻辑
- ✅ 支持全检判断

---

**版本**：v1.1  
**更新日期**：2025-11-22  
**适用标准**：GB/T2828.1-2003/ISO2859-1


